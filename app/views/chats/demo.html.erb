
<html>
  <head>
    <title>Opentok Quick Start</title>
    <script src='http://static.opentok.com/v2/js/opentok.min.js'></script>
    <script type="text/javascript">

$(document).ready(function() {	    
    
    var publisher;
    var streams = [];
    var token = "<%= @token %>";
    var watchers = 0;
	var streamers = 0;
    
    
    
    function connect() {
	  if (OT.checkSystemRequirements() == 0) {
        console.log("The client does not support WebRTC.");
      } else {
        console.log("The client does support WebRTC.");
        session = OT.initSession("45266732", "<%= @session_id %>");
		
		//Initial session connection
		//Local user connects to the session
		session.on("sessionConnected", function(event){
			console.log("sessionConnected by local user, watchers: "+watchers+" & streamers: "+ streamers);
		});	
			
		//session connection destroyed
		session.on("sessionDisconnected", function(event) {
			console.log("The session disconnected. " + event.reason);
			watchers--;
	    });
        
        	
		
		//forign user connects to the session
		session.on("connectionCreated", function(event){
			var stream = event.stream;
            watchers++;
            console.log("connectionCreated by forign user, watchers: "+watchers+" & streamers: "+ streamers);
        });
		
		//session connection destroyed
		session.on("connectionDestroyed", function(event){
			watchers--;
			console.log("session connection destroyed, watchers: "+watchers+" & streamers: "+ streamers);
        });
		
		
		
		//stream created by forign user
		session.on("streamCreated", function(event){
			console.log("new stream created by forign user")
		  	if(event.stream.connection.connectionId != session.connection.connectionId){
		  		if ( $('#ivid1').children().length < 3 ) {
				session.subscribe(event.stream, 'ivid1', {width:155, height:150, insertMode: 'append'});
				//setupJoin();
				
				$(".connectdown:first").attr('class', 'connectup');
				
		  		streamers++;
		  		console.log("sucsessfully subscribed to new forign stream 1of5, watchers: "+watchers+" & streamers: "+ streamers)
				}else if ( $('#ivid2').children().length < 3 ) {
				session.subscribe(event.stream, 'ivid2', {width:155, height:150, insertMode: 'append'});
				//setupJoin();
				
				
		  		streamers++;
		  		console.log("sucsessfully subscribed to new forign stream 2of5, watchers: "+watchers+" & streamers: "+ streamers)
				}else if ( $('#ivid3').children().length < 3 ) {
				session.subscribe(event.stream, 'ivid3', {width:155, height:150, insertMode: 'append'});
				setupJoin();
		  		streamers++;
		  		console.log("sucsessfully subscribed to new forign stream 3of5, watchers: "+watchers+" & streamers: "+ streamers)
				}else if ( $('#ivid4').children().length < 3 ) {
				session.subscribe(event.stream, 'ivid4', {width:155, height:150, insertMode: 'append'});
				setupJoin();
		  		streamers++;
		  		console.log("sucsessfully subscribed to new forign stream 4of5, watchers: "+watchers+" & streamers: "+ streamers)
				}else if ( $('#ivid5').children().length < 3 ) {
				session.subscribe(event.stream, 'ivid5', {width:155, height:150, insertMode: 'append'});
				setupJoin();
		  		streamers++;
		  		console.log("sucsessfully subscribed to new forign stream 5of5, watchers: "+watchers+" & streamers: "+ streamers)
				}else{
					
					
				console.log("no more room for streams")	
				}		
		  	}
		  	
		  });	
		  	

		//Local user stoped publishing to the session
		session.on("streamDestroyed", function(event){
			streamers--;
			console.log("forign user stopped streaming, watchers: "+watchers+" & streamers: "+ streamers);
			
			if ( $('#ivid1').children().length == 0 ){
				
			}else if ( $('#ivid2').children().length == 0 ){
				
			}else if ( $('#ivid3').children().length == 0 ){
				
			}else if ( $('#ivid4').children().length == 0 ){
				
			}else if ( $('#ivid5').children().length == 0 ){
				
			}else{
				// not sure what to do at this point zzzZZz
			}
			
			
		});	
		
		
		
		      
      
        // Replace token with your own value:
        session.connect(token, function(error) {
          if (error) {
            OT.log("Unable to connect: ", error.message);
          } else {
            //document.getElementById('disconnectBtn').style.display = 'block';
            //$('#disconnectBtn').hide();
            console.log("session.connect, Connected to the session.");
          }
        });
	  }
    }


  
$('.connectup, .connectdown').click( function (){
	
	$parentID = $(this).parent().attr('id');
	
	
	publisher = OT.initPublisher($parentID, {width:155, height:150, insertMode: 'append'});
	$('#' + $parentID + " .overlayno").attr('class', 'overlay');
	session.publish(publisher);
	
	
	
	
	return;
	
	console.log( $('#ivid1').children().length);
	if ( $('#ivid1').children().length == 2 ) {
		publisher = OT.initPublisher('ivid1', {width:155, height:150, insertMode: 'append'});
		$("#ivid1 .overlayno").attr('class', 'overlay');
		
		
		
		session.publish(publisher);
		
		console.log("publisher object was created on 1of5");
	}else if ( $('#ivid2').children().length == 2 ) {
		publisher = OT.initPublisher('ivid2', {width:155, height:150, insertMode: 'append'});
		$("#ivid2 .overlayno").attr('class', 'overlay');
		
		session.publish(publisher);
		
		console.log("publisher object was created on 2of5");
	}else if ( $('#ivid3').children().length == 2 ) {
		publisher = OT.initPublisher('ivid3', {width:155, height:150, insertMode: 'append'});
		$("#ivid3 .overlayno").attr('class', 'overlay');
		
		session.publish(publisher);
		
		console.log("publisher object was created on 3of5");
	}else if ( $('#ivid4').children().length == 2 ) {
		publisher = OT.initPublisher('ivid4', {width:155, height:150, insertMode: 'append'});
		$("#ivid4 .overlayno").attr('class', 'overlay');
		
		session.publish(publisher);
		
		console.log("publisher object was created on 4of5");
	}else if ( $('#ivid5').children().length == 2 ) {
		publisher = OT.initPublisher('ivid5', {width:155, height:150, insertMode: 'append'});
		$("#ivid5 .overlayno").attr('class', 'overlay');
		session.publish(publisher);
		
		console.log("publisher object was created on 5of5");
	}else{
		console.log("no more room to publish a stream!")
		return;
	}
	
    
	//Local user started publishing to the session
	publisher.on("streamCreated", function(event){
  	
  		streamers++;
    	console.log("local publisher started streaming, watchers: "+watchers+" & streamers: "+ streamers);
	});	  
 
	//Local user stoped publishing to the session
	publisher.on("streamDestroyed", function(event){
		streamers--;
		console.log("local publisher stopped streaming, watchers: "+watchers+" & streamers: "+ streamers);
    
	});	  
});  
      
      
      
     


function disconnect() {
  console.log("publisher dissstroyed")
  publisher.destroy();
  //session.unpublish(publisher);
  
  
};
		
		
function setupJoin(){
	if ( $('#ivid1').children().length == 2 ){
		$(".connect").attr('class', 'connect1');
		return;
	}else if ( $('#ivid2').children().length == 2 ){
		console.log('just do it');
		$('#ivid2').attr('class', '.connect');
		//$(".connect").attr('class', 'connect1');
		return;
	}else if ( $('#ivid3').children().length == 2 ){
		$(".connect").attr('class', 'connect1');
		return;
	}else if ( $('#ivid4').children().length == 2 ){
		$(".connect").attr('class', 'connect1');
		return;
	}else if ( $('#ivid5').children().length == 2 ){
		$(".connect").attr('class', 'connect1');
	}
	
}		
  
$('#quit_butt_1').click( function () { 
  disconnect();
 
 
});
      
//$('.connectup, .connectdown').click( function () {
//  publish();
//  console.log($('#ivid1').children().length);
//  console.log($('#ivid2').children().length);
//  console.log($('#ivid3').children().length);
//  console.log($('#ivid4').children().length);
//  console.log($('#ivid5').children().length);
//});
  

$('.overlayno').click( function(){
	//disconnect();
	//console.log($(this).parent().attr('id') );
	
	$parentID = $(this).parent().attr('id');
	
	if ( $parentID  == "ivid1" )    {
		console.log('ivid1');
		$("#ivid1 .overlay").attr('class', 'overlayno');
		disconnect();
		
	}else if (  $parentID == "ivid2" )    {
		console.log('ivid2');
		$("#ivid1 .overlay").attr('class', 'overlayno');
		disconnect();
	}else if (  $parentID == "ivid3" )    {
		console.log('tivid333u');
		$("#ivid1 .overlay").attr('class', 'overlayno');
		disconnect();
	}else if (  $parentID == "ivid4" )    {
		console.log('444');
		$("#ivid1 .overlay").attr('class', 'overlayno');
		disconnect();
	}else if (  $parentID == "ivid5" )    {
		console.log('555');
		$("#ivid1 .overlay").attr('class', 'overlayno');
		disconnect();
	}else{
		console.log('wtttff');
	}
});



connect();

});
    </script>
  </head>
  <body>
    
    <div id="streams_wrapper">
		<div id="streams_container">
         	<div id="streams_bin">
		    	<div id="ovid1">
		    		<div id="ivid1">
		    			
		    			<div class="connectup">
		    				<strong>(( (connect)) )</strong>
		    			</div>	
		    			
		    			<div class="overlayno">
		    				Disconnect.
		    			</div>
		    		</div>
		    	</div>		
				<div id="ovid2">
		    		<div id="ivid2">
		    			<div class="connectdown">
		    				<strong>(( (connect)) )</strong>
		    			</div>	
		    			
		    			<div class="overlayno">
		    				Disconnect.
		    			</div>
	    			</div>
		    	</div>
		    	<div id="ovid3">
		    		<div id="ivid3">
		    			<div class="connectdown">
		    				<strong>(( (connect)) )</strong>
		    			</div>	
		    			
		    			<div class="overlayno">
		    				Disconnect.
		    			</div>
		    	   </div>		
		    	</div>
		    	<div id="ovid4">
		    		<div id="ivid4">
		    			<div class="connectdown">
		    				<strong>(( (connect)) )</strong>
		    			</div>	
		    			
		    			<div class="overlayno">
		    				Disconnect.
		    			</div>
		    		</div> 	
		    	</div>
		    	<div id="ovid5">
		    		<div id="ivid5">
		    			<div class="connectdown">
		    				<strong>(( (connect)) )</strong>
		    			</div>	
		    			
		    			<div class="overlayno">
		    				Disconnect.
		    			</div>
	    			  </div>
		    	</div>
            </div>
	    </div>
	    
		<div id="chats_aside">
			<h1>H1 tag</h1>
			<h3> test aside</h3>
			
			
	    </div>
</div>
    
    
 
  </body>
</html>